<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>baseline. — Health Coverage Score</title>
<meta name="description" content="Enter your health data and get a real coverage score with NHANES percentile benchmarks and actionable gap analysis.">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;800&family=DM+Sans:wght@300;400;500;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="css/app.css">
</head>
<body>

<div class="container">
  <!-- Header -->
  <div class="app-header">
    <a href="../landing/" class="logo">baseline<span class="period">.</span></a>
    <a href="../landing/" class="back-to-landing">about</a>
  </div>

  <!-- Return visit banner -->
  <div class="return-banner" id="return-banner">
    <span>Welcome back. Your previous profile is saved. <strong>Update or start fresh?</strong></span>
    <div style="display:flex;gap:8px;">
      <button onclick="loadSavedProfile()">Load previous</button>
      <button onclick="clearSaved()">Start fresh</button>
    </div>
  </div>

  <!-- Questionnaire -->
  <div id="questionnaire">

    <!-- ═══ INTAKE: tab toggle between voice and form ═══ -->
    <div class="intake-tabs" id="intake-tabs">
      <button class="intake-tab active" data-tab="voice" onclick="switchIntakeTab('voice')">Talk it out <span class="disclaimer-badge">Experimental</span></button>
      <button class="intake-tab" data-tab="form" onclick="switchIntakeTab('form')">Type it in <span class="tab-field-count">23</span></button>
    </div>

    <div class="intake-split" id="intake-split">
    <div class="voice-hero" id="voice-hero">
      <div class="margin-note" id="voice-margin-note">
        <div class="margin-note-line"></div>
        <div class="margin-note-content">
          Your transcript is sent to AI for extraction and logged anonymously for quality improvement. No personal identifiers are stored. Results improve as we learn from how people describe their health.
        </div>
      </div>
      <!-- IDLE: centered mic, inviting -->
      <div class="voice-idle" id="voice-idle">
        <p class="voice-hero-sub">Tell us about yourself in 30 seconds.</p>
        <div class="voice-record-ring" onclick="toggleFullVoice()">
          <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5zm6 6c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
        </div>
        <div class="voice-idle-label">Tap to start</div>
      </div>

      <!-- ACTIVE: mic + AI guide left, checklist right -->
      <div class="voice-active" id="voice-active">
        <div class="voice-active-layout">
          <!-- Left: mic + AI guide fills the space -->
          <div class="voice-left">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:20px;">
              <div class="voice-record-ring" id="voice-ring" onclick="toggleFullVoice()" style="width:40px;height:40px;flex-shrink:0;">
                <svg viewBox="0 0 24 24" style="width:18px;height:18px;"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5zm6 6c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
              </div>
              <div class="voice-status" id="voice-full-status" style="text-align:left;">Listening...</div>
            </div>

            <!-- AI guide: nudge + processing — fills the left column -->
            <div class="voice-guide" id="voice-guide">
              <div id="guide-nudges"></div>
              <div class="guide-haiku-status" id="guide-haiku-status"></div>
            </div>
          </div>

          <!-- Right: checklist only -->
          <div class="voice-right">
            <div class="voice-checklist" id="voice-checklist">
              <div class="voice-checklist-item" data-check="age">
                <div class="check-box"></div>
                <span>Age</span>
              </div>
              <div class="voice-checklist-item" data-check="sex">
                <div class="check-box"></div>
                <span>Sex</span>
              </div>
              <div class="voice-checklist-item" data-check="height">
                <div class="check-box"></div>
                <span>Height</span>
              </div>
              <div class="voice-checklist-item" data-check="weight">
                <div class="check-box"></div>
                <span>Weight</span>
              </div>
              <div class="voice-checklist-item" data-check="labs">
                <div class="check-box"></div>
                <span>Lab results</span>
                <span class="check-hint" id="lab-count-hint">0 found</span>
              </div>
              <div class="voice-checklist-item" data-check="bp">
                <div class="check-box"></div>
                <span>Blood pressure</span>
              </div>
              <div class="voice-checklist-item" data-check="waist">
                <div class="check-box"></div>
                <span>Waist</span>
              </div>
              <div class="voice-checklist-item" data-check="history">
                <div class="check-box"></div>
                <span>Family hx</span>
              </div>
            </div>
          </div>
        </div>

        <textarea class="voice-transcript" id="voice-full-transcript" placeholder="Your words appear here as you speak..." style="margin-top:16px;"></textarea>

        <div class="voice-actions">
          <button class="voice-submit" id="voice-submit-btn" onclick="submitVoiceIntake()" disabled>Tap to submit</button>
        </div>
      </div>
    </div>

    <!-- Gap Bridge: post-dictation import prompts -->
    <div class="gap-bridge" id="gap-bridge">
      <div class="bridge-header">
        <h2>Nice — got it</h2>
        <div class="bridge-summary" id="bridge-summary"></div>
      </div>

      <div class="bridge-prompts" id="bridge-prompts">
        <!-- Dynamically populated based on what voice missed -->
      </div>

      <div class="bridge-actions">
        <button class="bridge-score-btn" onclick="bridgeScore()">See my score</button>
        <button class="bridge-skip-btn" onclick="bridgeScore()">Skip — score with what I have</button>
      </div>
    </div>

    </div><!-- /intake-split -->

    <div class="form-mode" id="form-mode">

    <div class="progress-bar" id="progress-bar"></div>

    <!-- Step 0: Demographics -->
    <div class="step active" data-step="0">
      <h2>About you</h2>
      <p class="step-hint">For percentile comparison. 10 seconds.</p>

      <div class="field-group" style="text-align:center;">
        <div class="field-label">Age</div>
        <input type="number" class="field-input" id="f-age" placeholder="35" min="18" max="100" style="max-width:100px;margin:0 auto;text-align:center;font-size:1.3rem;">
      </div>

      <div class="field-group" style="text-align:center;">
        <div class="field-label">Sex</div>
        <div class="option-group" id="f-sex" style="justify-content:center;">
          <div class="opt-btn" data-value="M">Male</div>
          <div class="opt-btn" data-value="F">Female</div>
        </div>
      </div>

      <div class="field-group">
        <div class="field-label" style="text-align:center;">Height & Weight</div>
        <div class="field-row" style="justify-content:center;">
          <div class="field-col" style="flex:0 0 80px;">
            <input type="number" class="field-input" id="f-height-ft" placeholder="5" min="3" max="8" step="1" style="text-align:center;">
            <div class="field-unit" style="text-align:center;">feet</div>
          </div>
          <div class="field-col" style="flex:0 0 80px;">
            <input type="number" class="field-input" id="f-height-in" placeholder="10" min="0" max="11" step="1" style="text-align:center;">
            <div class="field-unit" style="text-align:center;">inches</div>
          </div>
          <div class="field-col" style="flex:0 0 100px;">
            <input type="number" class="field-input" id="f-weight" placeholder="175" min="60" max="600" style="text-align:center;">
            <div class="field-unit" style="text-align:center;">lbs</div>
          </div>
        </div>
      </div>

      <div class="step-nav">
        <button class="nav-back hidden">&larr; Back</button>
        <button class="nav-next" onclick="nextStep()">Next &rarr;</button>
      </div>
    </div>

    <!-- Step 1: Import your data (labs + wearables) -->
    <div class="step" data-step="1">
      <h2>Import your data</h2>
      <p class="step-hint">Drop everything you have — lab PDFs, wearable exports, anything. We'll extract what we need.</p>

      <div class="field-group">
        <div class="field-label">Lab reports</div>
        <div class="upload-zone" id="lab-drop" onclick="document.getElementById('lab-file-input').click()">
          <div class="icon">&darr;</div>
          <div class="uz-title">Drop lab report PDFs here</div>
          <div class="uz-hint">or click to browse &middot; multiple files OK &middot; Quest, LabCorp, hospital, any format</div>
        </div>
        <input type="file" id="lab-file-input" accept=".pdf,.txt,.csv" multiple style="display:none" onchange="handleLabFileInput(event)">

        <div class="parse-summary" id="lab-import-summary"></div>
        <div id="lab-file-list"></div>
      </div>

      <div class="field-group" style="margin-top: 24px;">
        <div class="field-label">What do you track with?</div>
        <div class="device-grid" id="device-selector">
          <div class="device-card" data-device="apple_watch" onclick="toggleDevice(this)">
            <div class="device-icon">&#9201;</div>
            <div class="device-name">Apple Watch</div>
            <div class="device-check"></div>
          </div>
          <div class="device-card" data-device="garmin" onclick="toggleDevice(this)">
            <div class="device-icon">&#9650;</div>
            <div class="device-name">Garmin</div>
            <div class="device-check"></div>
          </div>
          <div class="device-card" data-device="oura" onclick="toggleDevice(this)">
            <div class="device-icon">&#9711;</div>
            <div class="device-name">Oura</div>
            <div class="device-check"></div>
          </div>
          <div class="device-card" data-device="fitbit" onclick="toggleDevice(this)">
            <div class="device-icon">&#9632;</div>
            <div class="device-name">Fitbit</div>
            <div class="device-check"></div>
          </div>
          <div class="device-card" data-device="whoop" onclick="toggleDevice(this)">
            <div class="device-icon">&#9644;</div>
            <div class="device-name">WHOOP</div>
            <div class="device-check"></div>
          </div>
          <div class="device-card" data-device="none" onclick="toggleDevice(this)">
            <div class="device-icon" style="opacity:0.25;">&#10005;</div>
            <div class="device-name">None</div>
            <div class="device-check"></div>
          </div>
        </div>
        <div class="device-notify">Select all that apply &middot; integrations coming soon</div>
      </div>

      <div class="field-group" style="margin-top: 24px;">
        <div class="field-label">Medications & supplements</div>
        <p style="font-size:0.85rem;color:var(--text-muted);margin-bottom:8px;">Type to search — select all that apply, or skip.</p>
        <div class="med-search-wrap">
          <input type="text" class="med-search-input" id="med-search" placeholder="e.g. tirzepatide, vitamin D, creatine..." autocomplete="off">
          <div class="med-dropdown" id="med-dropdown"></div>
        </div>
        <div class="med-tags" id="med-tags"></div>
      </div>

      <div class="or-divider">or paste text / enter manually</div>

      <button class="manual-toggle" onclick="togglePasteLabs()" id="paste-toggle">Paste lab text &darr;</button>
      <div class="manual-fields" id="paste-labs">
        <div class="field-group">
          <div class="field-label">When were these labs drawn?</div>
          <div class="field-row">
            <div class="field-col">
              <input type="month" class="field-input" id="f-lab-date" style="max-width:200px;">
              <div class="field-hint">Month & year is fine — we'll check freshness</div>
            </div>
            <div class="field-col">
              <div class="field-label" style="margin-bottom:8px;">Fasting blood draw?</div>
              <div class="toggle-group" data-field="fasting">
                <div class="toggle-btn" data-value="yes">Yes</div>
                <div class="toggle-btn" data-value="no">No</div>
                <div class="toggle-btn" data-value="unsure">Unsure</div>
              </div>
            </div>
          </div>
        </div>

        <div class="field-group">
          <div class="field-label">Paste or dictate lab results</div>
          <div class="voice-input-wrap">
            <textarea class="paste-area" id="lab-paste" placeholder="Paste here, or tap the mic and read your numbers:

&quot;LDL 128, HDL 52, triglycerides 95, ApoB 85, glucose 92&quot;

Any format works — we'll extract the values."></textarea>
            <button class="mic-btn" id="lab-mic" onclick="toggleVoice('lab-paste', this)" title="Dictate lab results">
              <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5zm6 6c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
            </button>
          </div>
          <div class="voice-hint" id="lab-voice-hint">Listening... speak your lab values</div>
          <button class="parse-btn" onclick="parseLabText()">Extract values</button>

          <div class="parse-results" id="parse-results">
            <div class="parse-summary" id="parse-summary"></div>
            <div class="parsed-values" id="parsed-values"></div>
          </div>
        </div>
      </div>

      <button class="manual-toggle" onclick="toggleManualLabs()">Show individual fields &darr;</button>
      <div class="manual-fields" id="manual-labs">
        <div class="field-group">
          <div class="field-label">Lipids</div>
          <div class="field-row">
            <div class="field-col">
              <input type="number" class="field-input" id="f-apob" placeholder="—" step="0.1">
              <div class="field-unit">ApoB (mg/dL)</div>
            </div>
            <div class="field-col">
              <input type="number" class="field-input" id="f-ldl" placeholder="—" step="0.1">
              <div class="field-unit">LDL-C (mg/dL)</div>
            </div>
          </div>
          <div class="field-row">
            <div class="field-col">
              <input type="number" class="field-input" id="f-hdl" placeholder="—" step="0.1">
              <div class="field-unit">HDL-C (mg/dL)</div>
            </div>
            <div class="field-col">
              <input type="number" class="field-input" id="f-trig" placeholder="—" step="0.1">
              <div class="field-unit">Triglycerides (mg/dL)</div>
            </div>
          </div>
        </div>

        <div class="field-group">
          <div class="field-label">Metabolic</div>
          <div class="field-row">
            <div class="field-col">
              <input type="number" class="field-input" id="f-glucose" placeholder="—" step="0.1">
              <div class="field-unit">Fasting Glucose (mg/dL)</div>
            </div>
            <div class="field-col">
              <input type="number" class="field-input" id="f-hba1c" placeholder="—" step="0.01">
              <div class="field-unit">HbA1c (%)</div>
            </div>
            <div class="field-col">
              <input type="number" class="field-input" id="f-insulin" placeholder="—" step="0.1">
              <div class="field-unit">Fasting Insulin (µIU/mL)</div>
            </div>
          </div>
        </div>

        <div class="field-group">
          <div class="field-label">Special markers</div>
          <div class="field-row">
            <div class="field-col">
              <input type="number" class="field-input" id="f-lpa" placeholder="—" step="0.1">
              <div class="field-unit">Lp(a) (nmol/L)</div>
            </div>
            <div class="field-col">
              <input type="number" class="field-input" id="f-hscrp" placeholder="—" step="0.01">
              <div class="field-unit">hs-CRP (mg/L)</div>
            </div>
          </div>
        </div>

        <div class="field-group">
          <div class="field-label">Liver enzymes</div>
          <div class="field-row">
            <div class="field-col">
              <input type="number" class="field-input" id="f-alt" placeholder="—" step="0.1">
              <div class="field-unit">ALT (U/L)</div>
            </div>
            <div class="field-col">
              <input type="number" class="field-input" id="f-ggt" placeholder="—" step="0.1">
              <div class="field-unit">GGT (U/L)</div>
            </div>
          </div>
        </div>

        <div class="field-group">
          <div class="field-label">CBC</div>
          <div class="field-row">
            <div class="field-col">
              <input type="number" class="field-input" id="f-hemoglobin" placeholder="—" step="0.1">
              <div class="field-unit">Hemoglobin (g/dL)</div>
            </div>
            <div class="field-col">
              <input type="number" class="field-input" id="f-wbc" placeholder="—" step="0.1">
              <div class="field-unit">WBC (K/µL)</div>
            </div>
            <div class="field-col">
              <input type="number" class="field-input" id="f-platelets" placeholder="—" step="1">
              <div class="field-unit">Platelets (K/µL)</div>
            </div>
          </div>
        </div>

        <div class="field-group">
          <div class="field-label">Thyroid & vitamins</div>
          <div class="field-row">
            <div class="field-col">
              <input type="number" class="field-input" id="f-tsh" placeholder="—" step="0.01">
              <div class="field-unit">TSH (mIU/L)</div>
            </div>
            <div class="field-col">
              <input type="number" class="field-input" id="f-vitd" placeholder="—" step="0.1">
              <div class="field-unit">Vitamin D (ng/mL)</div>
            </div>
            <div class="field-col">
              <input type="number" class="field-input" id="f-ferritin" placeholder="—" step="0.1">
              <div class="field-unit">Ferritin (ng/mL)</div>
            </div>
          </div>
        </div>
      </div>

      <div class="step-nav">
        <button class="nav-back" onclick="prevStep()">&larr; Back</button>
        <button class="nav-next" onclick="nextStep()">Next &rarr;</button>
      </div>
      <p class="skip-hint">Don't have labs? Skip — they'll show as gaps in your score.</p>
    </div>

    <!-- Step 2: Measurements (things you do yourself) -->
    <div class="step" data-step="2">
      <h2>Two quick measurements</h2>
      <p class="step-hint">Just a cuff and a tape measure. Skip what you don't have.</p>

      <div class="field-group" style="text-align:center;">
        <div class="field-label">Blood pressure</div>
        <div class="field-row" style="justify-content:center;">
          <div class="field-col" style="flex:0 0 110px;">
            <input type="number" class="field-input" id="f-sbp" placeholder="120" step="1" style="text-align:center;font-size:1.2rem;">
            <div class="field-unit" style="text-align:center;">systolic</div>
          </div>
          <div style="font-size:1.4rem;color:var(--text-dim);padding-top:8px;flex:0;">/</div>
          <div class="field-col" style="flex:0 0 110px;">
            <input type="number" class="field-input" id="f-dbp" placeholder="80" step="1" style="text-align:center;font-size:1.2rem;">
            <div class="field-unit" style="text-align:center;">diastolic</div>
          </div>
        </div>
      </div>

      <div class="field-group" style="text-align:center;margin-top:32px;">
        <div class="field-label">Waist</div>
        <div style="display:flex;justify-content:center;">
          <div style="flex:0 0 120px;">
            <input type="number" class="field-input" id="f-waist" placeholder="—" step="0.1" style="text-align:center;font-size:1.2rem;">
            <div class="field-unit" style="text-align:center;">inches at navel</div>
          </div>
        </div>
      </div>

      <!-- Hidden fields — populated by wearable import, not shown to user -->
      <input type="hidden" id="f-rhr">
      <input type="hidden" id="f-vo2">
      <input type="hidden" id="f-hrv">
      <input type="hidden" id="f-steps">
      <input type="hidden" id="f-zone2">
      <input type="hidden" id="f-sleep-hours">
      <input type="hidden" id="f-sleep-reg">

      <div class="step-nav">
        <button class="nav-back" onclick="prevStep()">&larr; Back</button>
        <button class="nav-next" onclick="nextStep()">Next &rarr;</button>
      </div>
      <p class="skip-hint">No cuff? No tape? Just skip.</p>
    </div>

    <!-- Step 3: Context -->
    <div class="step" data-step="3">
      <h2>Almost done</h2>
      <p class="step-hint">Two quick taps.</p>

      <div class="field-group">
        <div class="field-label">Family history</div>
        <p style="font-size:0.85rem;color:var(--text-muted);margin-bottom:10px;">Heart disease, stroke, or diabetes in the family?</p>
        <div class="toggle-group" data-field="family-history" style="justify-content:center;">
          <div class="toggle-btn" data-value="yes">Yes</div>
          <div class="toggle-btn" data-value="no">No</div>
          <div class="toggle-btn" data-value="skip">Don't know</div>
        </div>
      </div>

      <div class="field-group">
        <div class="field-label">Mental health screening</div>
        <p style="font-size:0.85rem;color:var(--text-muted);margin-bottom:10px;">PHQ-9 or similar in the last year?</p>
        <div class="toggle-group" data-field="phq9" style="justify-content:center;">
          <div class="toggle-btn" data-value="yes">Yes</div>
          <div class="toggle-btn" data-value="no">No</div>
        </div>
      </div>

      <div class="step-nav" style="flex-direction:column;gap:12px;align-items:stretch;">
        <button class="nav-next cta-final" onclick="computeResults()">See my score</button>
        <button class="nav-back" onclick="prevStep()" style="text-align:center;">&larr; Back</button>
      </div>
    </div>

    </div><!-- /form-mode -->
  </div>

  <!-- Results -->
  <div id="results">
  <div class="results-layout">
  <div class="results-main">
    <div class="results-header">
      <div class="dual-rings">
        <div class="ring-with-caption">
          <div class="score-ring">
            <svg viewBox="0 0 160 160">
              <circle class="track" cx="80" cy="80" r="70"/>
              <circle class="fill-ring" id="score-arc" cx="80" cy="80" r="70"/>
            </svg>
            <div class="score-number">
              <span class="pct" id="r-score">0%</span>
              <span class="label">coverage</span>
            </div>
          </div>
        </div>
        <div class="ring-with-caption">
          <div class="score-ring health-ring" id="health-ring">
            <svg viewBox="0 0 160 160">
              <circle class="track" cx="80" cy="80" r="70"/>
              <circle class="fill-ring" id="health-arc" cx="80" cy="80" r="70"/>
            </svg>
            <div class="score-number">
              <span class="pct" id="r-health">—</span>
              <span class="label">health</span>
            </div>
          </div>
          <span class="ring-caption" id="health-caption">vs US population (NHANES)</span>
        </div>
      </div>
      <p class="score-context" id="r-context"></p>

      <div class="tier-summary">
        <div class="tier-block">
          <div class="t-label">Foundation (T1)</div>
          <div class="t-track"><div class="t-fill" id="r-t1-fill" style="width:0%"></div></div>
          <div class="t-pct" id="r-t1-pct">0%</div>
        </div>
        <div class="tier-block">
          <div class="t-label">Enhanced (T2)</div>
          <div class="t-track"><div class="t-fill" id="r-t2-fill" style="width:0%"></div></div>
          <div class="t-pct" id="r-t2-pct">0%</div>
        </div>
      </div>
    </div>

    <!-- Action plan: moves + timeline + remaining gaps unified -->
    <div class="next-moves" id="r-moves"></div>

    <!-- Metric results -->
    <div class="results-section" id="r-tier1"></div>
    <div class="results-section" id="r-tier2"></div>

    <!-- Insights -->
    <div class="insights-section" id="r-insights"></div>
  </div><!-- /results-main -->

  <!-- Sticky sidebar — follows scroll on desktop -->
  <aside class="results-sidebar" id="results-sidebar">
    <button onclick="startOver()">Update values</button>
    <button onclick="exportProfile()">Export JSON</button>
    <button onclick="clearAndRestart()">Start fresh</button>
  </aside>
  </div><!-- /results-layout -->
</div><!-- /results -->

</div><!-- /container -->

<footer>
  <div class="container">
    <p>
      Percentiles: NHANES 2017-2020 (survey-weighted, continuous interpolation)<br>
      Your data is stored locally in your browser (IndexedDB). <a href="../landing/">andrewdeal.info/baseline</a>
    </p>
  </div>
</footer>

<script type="module" src="src/main.js"></script>

</body>
</html>
