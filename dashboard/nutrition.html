<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nutrition — Cut Tracker</title>
<link rel="stylesheet" href="shared.css">
</head>
<body>

<div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 8px;">
  <div class="header animate" style="margin-bottom: 0;">
    <h1>Nutrition</h1>
    <span class="tag">Active Cut</span>
  </div>
  <a href="cut_tracker.html" class="nav-link animate">← Dashboard</a>
</div>
<div class="subheader animate">
  Daily targets: 190g+ protein <span>·</span> ~180g carbs <span>·</span> ~60g fat <span>·</span> ~2,100 cal
</div>

<!-- Protein Hero -->
<div id="nutrition-panel" style="background: var(--surface); border-radius: 12px; padding: 24px; border: 1px solid var(--border); margin-bottom: 32px;" class="animate">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <div id="nutrition-title" class="chart-title" style="margin-bottom: 0;">
      <span class="dot teal"></span> <span id="nutrition-date-label">Today's Nutrition</span>
    </div>
    <div style="font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--text-muted);">UPDATED LIVE</div>
  </div>

  <!-- Protein remaining -->
  <div id="protein-section" style="margin-bottom: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 8px;">
      <div>
        <span id="protein-remaining" style="font-family: 'JetBrains Mono', monospace; font-size: 32px; font-weight: 700; color: var(--teal);">—g</span>
        <span style="font-family: 'JetBrains Mono', monospace; font-size: 13px; color: var(--text-muted); margin-left: 4px;">protein remaining</span>
      </div>
      <div style="text-align: right;">
        <span id="protein-eaten" style="font-family: 'JetBrains Mono', monospace; font-size: 13px; color: var(--text-dim);">—/190g eaten</span>
      </div>
    </div>
    <div style="height: 12px; background: var(--surface-2); border-radius: 6px; overflow: hidden; position: relative;">
      <div id="protein-bar" style="height: 100%; width: 0%; background: linear-gradient(90deg, var(--teal), #34d9b0); border-radius: 6px; transition: width 0.6s ease;"></div>
    </div>
    <div style="display: flex; justify-content: space-between; margin-top: 4px;">
      <span style="font-family: 'JetBrains Mono', monospace; font-size: 9px; color: var(--text-muted);">0g</span>
      <span style="font-family: 'JetBrains Mono', monospace; font-size: 9px; color: var(--teal); opacity: 0.5;">TARGET 190g</span>
    </div>
  </div>

  <!-- Remaining macros row -->
  <div id="macro-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1px; background: var(--border); border-radius: 8px; overflow: hidden; margin-bottom: 20px;">
    <div style="background: var(--surface-2); padding: 12px 16px; text-align: center;">
      <div id="carbs-remaining" style="font-family: 'JetBrains Mono', monospace; font-size: 20px; font-weight: 600; color: var(--text);">—g</div>
      <div style="font-family: 'JetBrains Mono', monospace; font-size: 9px; color: var(--text-muted); margin-top: 4px;">CARBS remaining</div>
      <div id="carbs-eaten" style="font-family: 'JetBrains Mono', monospace; font-size: 9px; color: var(--text-dim); margin-top: 2px;">—/180g eaten</div>
    </div>
    <div style="background: var(--surface-2); padding: 12px 16px; text-align: center;">
      <div id="fat-remaining" style="font-family: 'JetBrains Mono', monospace; font-size: 20px; font-weight: 600; color: var(--text);">—g</div>
      <div style="font-family: 'JetBrains Mono', monospace; font-size: 9px; color: var(--text-muted); margin-top: 4px;">FAT remaining</div>
      <div id="fat-eaten" style="font-family: 'JetBrains Mono', monospace; font-size: 9px; color: var(--text-dim); margin-top: 2px;">—/60g eaten</div>
    </div>
    <div style="background: var(--surface-2); padding: 12px 16px; text-align: center;">
      <div id="cal-remaining" style="font-family: 'JetBrains Mono', monospace; font-size: 20px; font-weight: 600; color: var(--text);">—</div>
      <div style="font-family: 'JetBrains Mono', monospace; font-size: 9px; color: var(--text-muted); margin-top: 4px;">CALORIES remaining</div>
      <div id="cal-eaten" style="font-family: 'JetBrains Mono', monospace; font-size: 9px; color: var(--text-dim); margin-top: 2px;">—/2,100 eaten</div>
    </div>
  </div>

  <!-- Daily Habits -->
  <div id="habits-strip" style="display: none; margin-bottom: 20px; padding: 12px 16px; background: var(--surface-2); border-radius: 8px;">
    <div style="font-family: 'JetBrains Mono', monospace; font-size: 10px; color: var(--text-muted); letter-spacing: 1px; margin-bottom: 10px;">DAILY HABITS</div>
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1px;">
      <div style="text-align: center;">
        <div id="habit-water" style="font-family: 'JetBrains Mono', monospace; font-size: 20px; font-weight: 600; color: var(--blue);">—</div>
        <div style="font-family: 'JetBrains Mono', monospace; font-size: 9px; color: var(--text-muted); margin-top: 2px;">WATER (oz)</div>
      </div>
      <div style="text-align: center;">
        <div id="habit-creatine" style="font-family: 'JetBrains Mono', monospace; font-size: 20px; font-weight: 600;">—</div>
        <div style="font-family: 'JetBrains Mono', monospace; font-size: 9px; color: var(--text-muted); margin-top: 2px;">CREATINE 5g</div>
      </div>
      <div style="text-align: center;">
        <div id="habit-electrolytes" style="font-family: 'JetBrains Mono', monospace; font-size: 20px; font-weight: 600;">—</div>
        <div style="font-family: 'JetBrains Mono', monospace; font-size: 9px; color: var(--text-muted); margin-top: 2px;">ELECTROLYTES</div>
      </div>
    </div>
  </div>

  <!-- Energy Balance -->
  <div id="energy-balance" style="display: none; margin-bottom: 20px; padding: 12px 16px; background: var(--surface-2); border-radius: 8px;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <div style="font-family: 'JetBrains Mono', monospace; font-size: 10px; color: var(--text-muted); letter-spacing: 1px;">ENERGY BALANCE</div>
      <div style="font-family: 'JetBrains Mono', monospace; font-size: 9px; color: var(--text-muted);">via Garmin</div>
    </div>
    <div style="display: grid; grid-template-columns: 1fr auto 1fr auto 1fr; gap: 8px; align-items: center; margin-top: 10px;">
      <div style="text-align: center;">
        <div id="burn-total" style="font-family: 'JetBrains Mono', monospace; font-size: 20px; font-weight: 600; color: var(--text);">—</div>
        <div style="font-family: 'JetBrains Mono', monospace; font-size: 9px; color: var(--text-muted); margin-top: 2px;">BURNED</div>
        <div id="burn-breakdown" style="font-family: 'JetBrains Mono', monospace; font-size: 9px; color: var(--text-dim); margin-top: 1px;"></div>
      </div>
      <div style="font-family: 'JetBrains Mono', monospace; font-size: 16px; color: var(--text-muted);">−</div>
      <div style="text-align: center;">
        <div id="burn-eaten" style="font-family: 'JetBrains Mono', monospace; font-size: 20px; font-weight: 600; color: var(--text);">—</div>
        <div style="font-family: 'JetBrains Mono', monospace; font-size: 9px; color: var(--text-muted); margin-top: 2px;">EATEN</div>
      </div>
      <div style="font-family: 'JetBrains Mono', monospace; font-size: 16px; color: var(--text-muted);">=</div>
      <div style="text-align: center;">
        <div id="burn-deficit" style="font-family: 'JetBrains Mono', monospace; font-size: 20px; font-weight: 600;">—</div>
        <div style="font-family: 'JetBrains Mono', monospace; font-size: 9px; color: var(--text-muted); margin-top: 2px;">DEFICIT</div>
        <div id="burn-rate" style="font-family: 'JetBrains Mono', monospace; font-size: 9px; color: var(--text-dim); margin-top: 1px;"></div>
      </div>
    </div>
  </div>

  <!-- Meal log -->
  <div style="font-family: 'JetBrains Mono', monospace; font-size: 10px; color: var(--text-muted); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 8px;">Meal Log</div>
  <div id="meal-log" style="display: flex; flex-direction: column; gap: 1px; background: var(--border); border-radius: 8px; overflow: hidden;">
    <div style="background: var(--surface-2); padding: 16px; text-align: center;">
      <span style="font-family: 'JetBrains Mono', monospace; font-size: 12px; color: var(--text-muted);">Loading meals...</span>
    </div>
  </div>
</div>

<!-- Daily Meal Template -->
<div class="section-divider"></div>
<div class="section-header animate">Daily Template</div>

<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1px; background: var(--border); border-radius: 12px; overflow: hidden; margin-top: 16px; margin-bottom: 16px;" class="animate">

  <!-- Meal 1: Morning -->
  <div style="background: var(--surface); padding: 20px;">
    <div style="font-family: 'JetBrains Mono', monospace; font-size: 10px; color: var(--text-muted); letter-spacing: 1px; text-transform: uppercase;">Meal 1 · Morning</div>
    <div style="margin-top: 12px; font-size: 13px; color: var(--text); line-height: 1.8;">
      3 RX Bars
    </div>
    <div style="margin-top: 12px; padding: 8px 10px; background: var(--surface-2); border-radius: 6px;">
      <div style="display: flex; justify-content: space-between;">
        <span style="font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--teal);">36g P</span>
        <span style="font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--text-muted);">72g C</span>
        <span style="font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--text-muted);">21g F</span>
      </div>
      <div style="font-family: 'JetBrains Mono', monospace; font-size: 10px; color: var(--text-muted); margin-top: 4px; text-align: right;">~600 cal</div>
    </div>
  </div>

  <!-- Meal 2: Pre-Workout -->
  <div style="background: var(--surface); padding: 20px;">
    <div style="font-family: 'JetBrains Mono', monospace; font-size: 10px; color: var(--text-muted); letter-spacing: 1px; text-transform: uppercase;">Meal 2 · Pre-Workout</div>
    <div style="font-size: 10px; color: var(--amber); margin-top: 2px;">30-45 min before session</div>
    <div style="margin-top: 10px; font-size: 13px; color: var(--text); line-height: 1.8;">
      2 whey shakes (32g ea)<br>
      4 medium bananas
    </div>
    <div style="margin-top: 12px; padding: 8px 10px; background: var(--surface-2); border-radius: 6px;">
      <div style="display: flex; justify-content: space-between;">
        <span style="font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--teal);">64g P</span>
        <span style="font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--text-muted);">120g C</span>
        <span style="font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--text-muted);">4g F</span>
      </div>
      <div style="font-family: 'JetBrains Mono', monospace; font-size: 10px; color: var(--text-muted); margin-top: 4px; text-align: right;">~770 cal</div>
    </div>
  </div>

  <!-- Meal 3: Post-Workout -->
  <div style="background: var(--surface); padding: 20px;">
    <div style="font-family: 'JetBrains Mono', monospace; font-size: 10px; color: var(--text-muted); letter-spacing: 1px; text-transform: uppercase;">Meal 3 · Post-Workout</div>
    <div style="font-size: 10px; color: var(--blue); margin-top: 2px;">The flex meal</div>
    <div style="margin-top: 10px; font-size: 12px; color: var(--text-dim); line-height: 1.8;">
      <span style="color: var(--text);">Options:</span><br>
      8 eggs scrambled (~48g P)<br>
      8oz ground beef + rice (~50g P)<br>
      ½ rotisserie chicken (~55g P)<br>
    </div>
    <div style="margin-top: 12px; padding: 8px 10px; background: var(--surface-2); border-radius: 6px;">
      <div style="display: flex; justify-content: space-between;">
        <span style="font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--teal);">~50g P</span>
        <span style="font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--text-muted);">~40g C</span>
        <span style="font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--text-muted);">~15g F</span>
      </div>
      <div style="font-family: 'JetBrains Mono', monospace; font-size: 10px; color: var(--text-muted); margin-top: 4px; text-align: right;">~500 cal</div>
    </div>
  </div>

  <!-- Meal 4: Night -->
  <div style="background: var(--surface); padding: 20px;">
    <div style="font-family: 'JetBrains Mono', monospace; font-size: 10px; color: var(--text-muted); letter-spacing: 1px; text-transform: uppercase;">Meal 4 · Night</div>
    <div style="font-size: 10px; color: var(--text-muted); margin-top: 2px;">Recovery + sleep</div>
    <div style="margin-top: 10px; font-size: 13px; color: var(--text); line-height: 1.8;">
      Casein shake<br>
      1 banana<br>
      5g creatine
    </div>
    <div style="margin-top: 12px; padding: 8px 10px; background: var(--surface-2); border-radius: 6px;">
      <div style="display: flex; justify-content: space-between;">
        <span style="font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--teal);">30g P</span>
        <span style="font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--text-muted);">30g C</span>
        <span style="font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--text-muted);">2g F</span>
      </div>
      <div style="font-family: 'JetBrains Mono', monospace; font-size: 10px; color: var(--text-muted); margin-top: 4px; text-align: right;">~260 cal</div>
    </div>
  </div>
</div>

<!-- Daily Totals -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1px; background: var(--border); border-radius: 12px; overflow: hidden; margin-bottom: 32px;" class="animate">
  <div style="background: var(--surface); padding: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <div>
        <div style="font-family: 'JetBrains Mono', monospace; font-size: 10px; color: var(--text-muted); letter-spacing: 1px;">TRAINING DAY TOTALS</div>
        <div style="display: flex; gap: 20px; margin-top: 8px;">
          <div>
            <span style="font-family: 'JetBrains Mono', monospace; font-size: 22px; font-weight: 600; color: var(--teal);">180g</span>
            <span style="font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--text-muted);"> P</span>
          </div>
          <div>
            <span style="font-family: 'JetBrains Mono', monospace; font-size: 22px; font-weight: 600; color: var(--text-dim);">262g</span>
            <span style="font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--text-muted);"> C</span>
          </div>
          <div>
            <span style="font-family: 'JetBrains Mono', monospace; font-size: 22px; font-weight: 600; color: var(--text-dim);">42g</span>
            <span style="font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--text-muted);"> F</span>
          </div>
          <div>
            <span style="font-family: 'JetBrains Mono', monospace; font-size: 22px; font-weight: 600; color: var(--text);">~2,130</span>
            <span style="font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--text-muted);"> cal</span>
          </div>
        </div>
      </div>
    </div>
    <div style="font-size: 11px; color: var(--amber); margin-top: 8px;">+300 cal gap → fill with carbs (bigger rice portion, extra banana)</div>
  </div>
  <div style="background: var(--surface); padding: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <div>
        <div style="font-family: 'JetBrains Mono', monospace; font-size: 10px; color: var(--text-muted); letter-spacing: 1px;">REST DAY ADJUSTMENT</div>
        <div style="font-size: 13px; color: var(--text-dim); margin-top: 8px; line-height: 1.7;">
          Same protein (180g+). Drop pre-workout bananas.<br>
          Fill gap with fat: <span style="color: var(--text);">2 tbsp PB in casein shake</span> (+190 cal)<br>
          or handful of almonds (+160 cal).
        </div>
      </div>
    </div>
    <div style="font-size: 11px; color: var(--text-muted); margin-top: 8px;">Carbs flex down on rest days. Fat up. Protein never changes.</div>
  </div>
</div>

<script src="shared.js"></script>
<script>
(async function() {
  const [mealText, burnText, habitsText] = await Promise.all([
    safeFetch('../meal_log.csv'),
    safeFetch('../garmin_daily_burn.json', true),
    safeFetch('../daily_habits.csv'),
  ]);

  if (!mealText) {
    document.getElementById('meal-log').innerHTML = `
      <div style="background: var(--surface-2); padding: 16px; text-align: center;">
        <span style="font-family: 'JetBrains Mono', monospace; font-size: 12px; color: var(--text-muted);">No meal data available</span>
      </div>`;
    return;
  }

  try {
    const allMeals = parseCSV(mealText);
    const today = todayStr();
    const meals = allMeals.filter(m => m.date === today);

    // Date label
    const dateLabel = document.getElementById('nutrition-date-label');
    if (dateLabel) {
      const d = new Date(today + 'T00:00:00');
      const dayName = d.toLocaleDateString('en-US', { weekday: 'long' });
      const monthDay = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      dateLabel.textContent = `Today's Nutrition · ${monthDay}`;
    }

    if (!meals.length) {
      document.getElementById('protein-remaining').textContent = '190g';
      document.getElementById('protein-eaten').textContent = '0/190g eaten';
      document.getElementById('carbs-remaining').textContent = '180g';
      document.getElementById('carbs-eaten').textContent = '0/180g eaten';
      document.getElementById('fat-remaining').textContent = '60g';
      document.getElementById('fat-eaten').textContent = '0/60g eaten';
      document.getElementById('cal-remaining').textContent = '2,100';
      document.getElementById('cal-eaten').textContent = '0/2,100 eaten';
      document.getElementById('meal-log').innerHTML = `
        <div style="background: var(--surface-2); padding: 16px; text-align: center;">
          <span style="font-family: 'JetBrains Mono', monospace; font-size: 12px; color: var(--text-muted);">No meals logged today</span>
        </div>`;
      return;
    }

    const eaten = { protein: 0, carbs: 0, fat: 0, calories: 0 };
    meals.forEach(m => {
      eaten.protein += parseFloat(m.protein_g) || 0;
      eaten.carbs += parseFloat(m.carbs_g) || 0;
      eaten.fat += parseFloat(m.fat_g) || 0;
      eaten.calories += parseFloat(m.calories) || 0;
    });

    const rem = {
      protein: Math.max(0, Math.round(CUT.macroTargets.protein - eaten.protein)),
      carbs: Math.max(0, Math.round(CUT.macroTargets.carbs - eaten.carbs)),
      fat: Math.max(0, Math.round(CUT.macroTargets.fat - eaten.fat)),
      calories: Math.max(0, Math.round(CUT.macroTargets.calories - eaten.calories)),
    };
    const protPct = Math.min(100, eaten.protein / CUT.macroTargets.protein * 100);

    // Protein hero
    document.getElementById('protein-remaining').textContent = rem.protein + 'g';
    document.getElementById('protein-eaten').textContent = Math.round(eaten.protein) + '/190g eaten';
    document.getElementById('protein-bar').style.width = protPct.toFixed(1) + '%';

    // Over-target coloring
    if (eaten.protein >= CUT.macroTargets.protein) {
      document.getElementById('protein-remaining').style.color = 'var(--teal)';
      document.getElementById('protein-remaining').textContent = '0g';
    }

    // Macro grid
    const ec = Math.round(eaten.carbs), ef = Math.round(eaten.fat), ecal = Math.round(eaten.calories);
    document.getElementById('carbs-remaining').textContent = rem.carbs + 'g';
    document.getElementById('carbs-remaining').style.color = ec > CUT.macroTargets.carbs ? 'var(--accent)' : 'var(--text)';
    document.getElementById('carbs-eaten').textContent = ec + '/180g eaten';

    document.getElementById('fat-remaining').textContent = rem.fat + 'g';
    document.getElementById('fat-remaining').style.color = ef > CUT.macroTargets.fat ? 'var(--accent)' : 'var(--text)';
    document.getElementById('fat-eaten').textContent = ef + '/60g eaten';

    document.getElementById('cal-remaining').textContent = rem.calories.toLocaleString();
    document.getElementById('cal-remaining').style.color = ecal > CUT.macroTargets.calories ? 'var(--accent)' : 'var(--text)';
    document.getElementById('cal-eaten').textContent = ecal.toLocaleString() + '/2,100 eaten';

    // Meal log
    const ml = document.getElementById('meal-log');
    ml.innerHTML = meals.map(m => `
      <div style="background: var(--surface-2); padding: 10px 16px; display: grid; grid-template-columns: 70px 1fr 60px 60px 60px 60px; align-items: center; gap: 8px;">
        <div style="font-family: 'JetBrains Mono', monospace; font-size: 10px; color: var(--text-muted);">${m.time_of_day}</div>
        <div style="font-size: 12px; color: var(--text);">${m.description}</div>
        <div style="font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--teal); text-align: right;">${Math.round(parseFloat(m.protein_g))}g P</div>
        <div style="font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--text-muted); text-align: right;">${Math.round(parseFloat(m.carbs_g))}g C</div>
        <div style="font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--text-muted); text-align: right;">${Math.round(parseFloat(m.fat_g))}g F</div>
        <div style="font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--text-dim); text-align: right;">${Math.round(parseFloat(m.calories))}</div>
      </div>
    `).join('');

  } catch(e) { console.warn('Nutrition update failed:', e); }

  // Daily habits
  if (habitsText) try {
    const habits = parseCSV(habitsText);
    const today = todayStr();
    const todayHabit = habits.find(h => h.date === today);
    if (todayHabit) {
      document.getElementById('habits-strip').style.display = 'block';
      const waterEl = document.getElementById('habit-water');
      const waterOz = parseInt(todayHabit.water_oz) || 0;
      waterEl.textContent = waterOz;
      waterEl.style.color = waterOz >= 100 ? 'var(--teal)' : waterOz > 0 ? 'var(--blue)' : 'var(--text-dim)';

      const creatineEl = document.getElementById('habit-creatine');
      const creatine = todayHabit.creatine?.toLowerCase() === 'y';
      creatineEl.textContent = creatine ? '\u2713' : '\u2717';
      creatineEl.style.color = creatine ? 'var(--teal)' : 'var(--text-dim)';

      const electroEl = document.getElementById('habit-electrolytes');
      const electro = todayHabit.electrolytes?.toLowerCase() === 'y';
      electroEl.textContent = electro ? '\u2713' : '\u2717';
      electroEl.style.color = electro ? 'var(--teal)' : 'var(--text-dim)';
    }
  } catch(e) { console.warn('Habits failed:', e); }

  // Energy balance from Garmin burn data
  if (burnText) try {
    const burns = typeof burnText === 'string' ? JSON.parse(burnText) : burnText;
    const today = todayStr();
    const todayBurn = burns.find(b => b.date === today);
    if (todayBurn && todayBurn.total) {
      const panel = document.getElementById('energy-balance');
      panel.style.display = 'block';

      const total = Math.round(todayBurn.total);
      const active = Math.round(todayBurn.active || 0);
      const bmr = Math.round(todayBurn.bmr || 0);
      document.getElementById('burn-total').textContent = total.toLocaleString();
      document.getElementById('burn-breakdown').textContent = `${bmr.toLocaleString()} BMR + ${active.toLocaleString()} active`;

      // Get eaten calories from meal data
      const allMeals = mealText ? parseCSV(mealText) : [];
      const todayMeals = allMeals.filter(m => m.date === today);
      let eatenCal = 0;
      todayMeals.forEach(m => { eatenCal += parseFloat(m.calories) || 0; });
      document.getElementById('burn-eaten').textContent = Math.round(eatenCal).toLocaleString();

      const deficit = total - Math.round(eatenCal);
      const defEl = document.getElementById('burn-deficit');
      defEl.textContent = (deficit > 0 ? '−' : '+') + Math.abs(deficit).toLocaleString();
      defEl.style.color = deficit > 0 ? 'var(--teal)' : 'var(--accent)';

      // Show weekly rate estimate (3500 cal = 1 lb)
      const lbPerWeek = (deficit * 7 / 3500).toFixed(1);
      document.getElementById('burn-rate').textContent = deficit > 0 ? `~${lbPerWeek} lb/wk pace` : '';
    }
  } catch(e) { console.warn('Energy balance failed:', e); }

  console.log('Nutrition page: data loaded');
})();
</script>
</body>
</html>
